name: Service Monitoring Deploy

on:
  push:
    branches: [main]
  workflow_dispatch: {}

concurrency:
  group: service-monitoring-prod
  cancel-in-progress: false

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build test image
        run: docker build -t service-monitoring:ci .

      - name: Run tests (HTTP + Playwright UI)
        run: |
          docker run --rm \
            -v "$GITHUB_WORKSPACE:/work" \
            -w /work \
            service-monitoring:ci \
            sh -lc "pip install --no-cache-dir -r requirements-dev.txt && python -m pytest"

  deploy-prod:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Deploy to production (SSH + Docker)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: 22
          script: |
            set -euo pipefail

            APP_NAME="service-monitoring"
            OLD_NAME="monitoring"
            IMAGE_SHA="service-monitoring:${{ github.sha }}"
            IMAGE_LATEST="service-monitoring:latest"

            echo "üöÄ Deploying ${APP_NAME} @ ${{ github.sha }}"

            DEPLOY_DIR="/tmp/${APP_NAME}-deploy-${{ github.run_id }}-${{ github.run_attempt }}"
            mkdir -p "$DEPLOY_DIR"
            cd "$DEPLOY_DIR"

            echo "üì• Cloning repo..."
            git clone https://github.com/JoshuaSeth/pitchai-monitoring.git .
            git checkout ${{ github.sha }}

            if docker ps -a --format '{{.Names}}' | grep -qx "$OLD_NAME"; then
              old_image="$(docker inspect "$OLD_NAME" --format '{{.Config.Image}}' || true)"
              echo "Found legacy container '$OLD_NAME' image=$old_image"
              if [[ "$old_image" == monitoring-system:* || "$old_image" == monitoring-system || "$old_image" == service-monitoring:* || "$old_image" == service-monitoring ]]; then
                echo "üõë Stopping legacy container: $OLD_NAME"
                docker stop "$OLD_NAME" || true
                docker rm "$OLD_NAME" || true
              else
                echo "‚ö†Ô∏è Refusing to stop '$OLD_NAME' (unexpected image: $old_image)"
              fi
            fi

            if docker ps -a --format '{{.Names}}' | grep -qx "$APP_NAME"; then
              echo "üõë Stopping existing container: $APP_NAME"
              docker stop "$APP_NAME" || true
              docker rm "$APP_NAME" || true
            fi

            echo "üî® Building image..."
            docker build -t "$IMAGE_SHA" -t "$IMAGE_LATEST" .

            echo "üöÄ Starting container..."
            docker volume create service-monitoring-state >/dev/null
            docker run -d \
              --name "$APP_NAME" \
              --restart unless-stopped \
              --init \
              --shm-size 1g \
              -v service-monitoring-state:/data \
              -e TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}" \
              -e TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}" \
              -e PITCHAI_DISPATCH_BASE_URL="https://dispatch.pitchai.net" \
              -e PITCHAI_DISPATCH_TOKEN="${{ secrets.PITCHAI_DISPATCH_TOKEN }}" \
              -e STATE_PATH="/data/state.json" \
              "$IMAGE_SHA"

            echo "‚è≥ Waiting for startup..."
            sleep 10

            running="$(docker inspect "$APP_NAME" --format '{{.State.Running}}')"
            if [[ "$running" != "true" ]]; then
              echo "‚ùå Container is not running"
              docker logs "$APP_NAME" --tail 200 || true
              exit 1
            fi

            echo "‚úÖ Container running"
            docker ps --filter "name=${APP_NAME}"
            docker logs "$APP_NAME" --tail 80 || true

            cd /
            rm -rf "$DEPLOY_DIR"
